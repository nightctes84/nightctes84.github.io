<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Segundo Desaf√≠o: Juego del Calamar</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        /* (Se mantienen los estilos originales que ya ten√≠as) */
    </style>
</head>
<body>
    <div class="container">
        <div class="timer" id="timerDisplay"><span>01:00</span></div>
        <div class="welcome-message" id="welcomeMessage"></div>

        <h1>¬°SEGUNDO DESAFIO!</h1>
        <p>Al llegar a un domicilio, observas que el cliente tiene una mascota suelta en el interior. ¬øc√≥mo proceder√≠as?</p>

        <div class="options-container">
            <button class="option-button" data-value="calmar">Intentas calmar al animal llev√°ndole comida o acarici√°ndolo</button>
            <button class="option-button" data-value="solicitar">Solicitas al cliente que retire al animal antes de ingresar</button>
            <button class="option-button" data-value="ingresar">Ingresar r√°pidamente para evitar que el animal interfiera</button>
            <button class="option-button" data-value="objeto">Utilizas un objeto para mantenerlo alejado y continuar la tarea</button>
        </div>

        <button id="submitButton">Responder</button>
        <button id="nextButton">Siguiente</button>

        <div id="feedbackMessage" class="message"></div>
    </div>

    <div class="game-over-modal-overlay" id="gameOverModal">
        <div class="game-over-modal-content">
            <h2>GAME OVER</h2>
            <p>Has sido eliminado del juego.</p>
            <button id="restartButton">Salir</button>
        </div>
    </div>

    <script>
        const timerDisplay = document.getElementById('timerDisplay');
        const optionButtons = document.querySelectorAll('.option-button');
        const submitButton = document.getElementById('submitButton');
        const nextButton = document.getElementById('nextButton');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const correctAnswer = 'solicitar'; 
        const totalTime = 60;
        let timeLeft = totalTime;
        let timerInterval;
        let selectedOption = null;
        let gameEnded = false;

        // Modal
        const gameOverModal = document.getElementById('gameOverModal');
        const restartButton = document.getElementById('restartButton');

        // URL Google Apps Script
        const googleAppsScriptURL = 'https://script.google.com/macros/s/AKfycbzKi8wMWmW3nlXqj2SlJWFwo6IoSOguVYYmoggTjRKqCu98KfA09zfBAmxyDgYlhoSdzQ/exec';

        // Obtener par√°metros de URL
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        const userName = getUrlParameter('user');
        const userCity = getUrlParameter('city');
        if (userName) welcomeMessage.textContent = `¬°Jugador: ${userName}!`;

        // Enviar datos a Google Sheets
        async function sendGameData(name, city, gamePage, timeTaken) {
            const formData = new FormData();
            formData.append('nombre', name);
            formData.append('localidad', city);
            formData.append('gamePage', gamePage);
            formData.append('timeTaken', timeTaken);

            try {
                await fetch(googleAppsScriptURL, { method: 'POST', body: formData });
                console.log("Datos enviados correctamente");
            } catch (err) {
                console.error("Error al enviar", err);
            }
        }

        // Timer
        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.querySelector('span').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                if (!gameEnded) {
                    endGame(false);
                    sendGameData(userName, userCity, '2', 0);
                }
            } else {
                timeLeft--;
            }
        }

        function endGame(isCorrect) {
            gameEnded = true;
            clearInterval(timerInterval);
            optionButtons.forEach(button => button.disabled = true);
            submitButton.style.display = 'none';

            if (isCorrect) {
                feedbackMessage.textContent = "¬°Respuesta correcta! üéâ";
                feedbackMessage.classList.add('correct-message');
                nextButton.style.display = 'block';
                sendGameData(userName, userCity, '2', totalTime - timeLeft);
                setTimeout(() => {
                    window.location.href = `Squidgame3.html?user=${encodeURIComponent(userName)}&city=${encodeURIComponent(userCity)}`;
                }, 3000);
            } else {
                gameOverModal.classList.add('show');
                sendGameData(userName, userCity, '2', totalTime - timeLeft);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            timerInterval = setInterval(updateTimer, 1000);
            submitButton.disabled = true;
        });

        optionButtons.forEach(button => {
            button.addEventListener('click', () => {
                if (gameEnded) return;
                optionButtons.forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                selectedOption = button.dataset.value;
                submitButton.disabled = false;
            });
        });

        submitButton.addEventListener('click', () => {
            if (selectedOption === correctAnswer) endGame(true);
            else endGame(false);
        });

        restartButton.addEventListener('click', () => {
            window.location.href = `game over.html`;
        });
    </script>
</body>
</html>
