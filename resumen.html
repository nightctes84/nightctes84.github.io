<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progreso por Ciudad</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #0056b3;
            margin-bottom: 20px;
        }
        /* Ajuste para centrar el h2 sobre la tabla */
        .city-table-wrapper { /* Nueva clase para envolver cada h2 y tabla */
            text-align: center; /* Centra el texto (h2) */
            flex-grow: 1;
            min-width: 300px; /* Asegura que no se hagan demasiado pequeñas */
        }
        .city-table-wrapper h2 {
            color: #0056b3;
            margin-bottom: 10px; /* Espacio entre el título y la tabla */
        }
        .table-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }
        table {
            width: 100%; /* La tabla ocupará el 100% del ancho de su contenedor (.city-table-wrapper) */
            border-collapse: collapse;
            margin-top: 0; /* Quitamos el margen superior aquí, ya que el h2 tiene margen inferior */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background-color: #fff;
            margin-left: auto; /* Centrar la tabla si su ancho es menor que el del contenedor */
            margin-right: auto; /* Centrar la tabla si su ancho es menor que el del contenedor */
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
        #loading {
            text-align: center;
            font-size: 1.2em;
            color: #555;
            margin-top: 30px;
        }
        .error-message {
            color: #d9534f;
            text-align: center;
            margin-top: 20px;
            font-weight: bold;
        }
        @media (max-width: 768px) {
            .table-container {
                flex-direction: column;
                align-items: center;
            }
            .city-table-wrapper {
                width: 95%; /* Ocupa casi todo el ancho en pantallas pequeñas */
            }
        }
    </style>
</head>
<body>
    <h1>Progreso de Usuarios por Ciudad</h1>

    <div id="loading">Cargando datos...</div>
    <div id="errorMessage" class="error-message" style="display:none;"></div>

    <div class="table-container">
        <div class="city-table-wrapper">
            <h2>Bahía Blanca</h2>
            <table id="bahiaBlancaTable">
                <thead>
                    <tr>
                        <th>Nombre del Usuario</th>
                        <th>Máximo Game Page</th>
                        <th>Tiempo Total (segundos)</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

        <div class="city-table-wrapper">
            <h2>Paraná</h2>
            <table id="paranaTable">
                <thead>
                    <tr>
                        <th>Nombre del Usuario</th>
                        <th>Máximo Game Page</th>
                        <th>Tiempo Total (segundos)</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        async function fetchUserData() {
            const loadingDiv = document.getElementById('loading');
            const errorMessageDiv = document.getElementById('errorMessage');
            loadingDiv.style.display = 'block'; // Mostrar mensaje de carga
            errorMessageDiv.style.display = 'none'; // Ocultar cualquier error previo

            const bahiaBlancaTableBody = document.querySelector('#bahiaBlancaTable tbody');
            const paranaTableBody = document.querySelector('#paranaTable tbody');

            // Limpiar tablas antes de añadir nuevos datos
            bahiaBlancaTableBody.innerHTML = '';
            paranaTableBody.innerHTML = '';

            const SPREADSHEET_ID = '1kfNWpoj-Svouh1Q7xiug67MEjTWDdeItL96sCLS_p7w';
            const API_KEY = 'AIzaSyAY4PTzTAqm0mwJvV742E0ZTUNQH63BQbg'; // Tu clave de API real
            const RANGE = 'Hoja 1!A1:E'; 

            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.values && data.values.length > 1) {
                    const rows = data.values.slice(1); // Excluir encabezados

                    const usersByCity = {
                        'Bahía Blanca': new Map(),
                        'Paraná': new Map()
                    };

                    rows.forEach(row => {
                        const timestamp = row[0]; // Columna 'Timestamp' (índice 0)
                        const userName = row[1];   // Columna 'nombre' (índice 1)
                        const city = row[2];       // Columna 'localidad' (índice 2)
                        const gamePageRaw = row[3]; // Columna 'gamePage' (índice 3)
                        const timeTakenRaw = row[4]; // Columna 'timeTaken' (índice 4)

                        // Intentar parsear gamePage a número, manejando 'Registro' como 0
                        let gamePageValue;
                        if (gamePageRaw === 'Registro') {
                            gamePageValue = 0;
                        } else {
                            gamePageValue = parseInt(gamePageRaw);
                        }

                        // Intentar parsear timeTaken a número
                        const timeTakenValue = parseInt(timeTakenRaw);

                        // Solo procesar si userName y city son válidos y gamePageValue es un número
                        if (userName && city && !isNaN(gamePageValue)) {
                            if (usersByCity[city]) {
                                if (!usersByCity[city].has(userName)) {
                                    usersByCity[city].set(userName, {
                                        maxGamePage: -1, // Inicializar con un valor bajo para asegurar que el primer gamePage sea el máximo
                                        totalTime: 0
                                    });
                                }

                                const userData = usersByCity[city].get(userName);

                                // Actualizar maxGamePage
                                if (gamePageValue > userData.maxGamePage) {
                                    userData.maxGamePage = gamePageValue;
                                }

                                // Sumar timeTaken si es un número válido
                                if (!isNaN(timeTakenValue)) {
                                    userData.totalTime += timeTakenValue;
                                }
                            }
                        }
                    });

                    // Función para poblar una tabla específica
                    function populateTable(tableBody, usersMap) {
                        if (usersMap.size > 0) {
                            usersMap.forEach((data, userName) => {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                                    <td>${userName}</td>
                                    <td>${data.maxGamePage === 0 ? 'Registro' : data.maxGamePage}</td>
                                    <td>${data.totalTime}</td>
                                `;
                                tableBody.appendChild(tr);
                            });
                        } else {
                            tableBody.innerHTML = '<tr><td colspan="3">No hay datos disponibles para esta ciudad.</td></tr>';
                        }
                    }

                    populateTable(bahiaBlancaTableBody, usersByCity['Bahía Blanca']);
                    populateTable(paranaTableBody, usersByCity['Paraná']);

                } else {
                    bahiaBlancaTableBody.innerHTML = '<tr><td colspan="3">No hay datos disponibles en la hoja de cálculo.</td></tr>';
                    paranaTableBody.innerHTML = '<tr><td colspan="3">No hay datos disponibles en la hoja de cálculo.</td></tr>';
                }

            } catch (error) {
                console.error('Error al obtener los datos:', error);
                errorMessageDiv.textContent = `Error al cargar los datos: ${error.message}. Por favor, revisa tu clave de API y el acceso a la hoja.`;
                errorMessageDiv.style.display = 'block';
                bahiaBlancaTableBody.innerHTML = '<tr><td colspan="3">Error al cargar.</td></tr>';
                paranaTableBody.innerHTML = '<tr><td colspan="3">Error al cargar.</td></tr>';
            } finally {
                loadingDiv.style.display = 'none'; // Ocultar mensaje de carga
            }
        }

        // Cargar los datos la primera vez
        fetchUserData();

        // Actualizar los datos cada 5 segundos
        setInterval(fetchUserData, 5000);
    </script>
</body>
</html>
