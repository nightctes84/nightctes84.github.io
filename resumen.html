<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progreso por Ciudad</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #0d1a26;
            color: #ecf0f1;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            flex-direction: column;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            background: radial-gradient(circle at center, #1a2a3a 0%, #0d1a26 100%);
        }

        h1 {
            color: #ecf0f1;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 10px #f1c40f, 0 0 20px #f1c40f;
            animation: glow-text 2s infinite alternate;
        }
        
        @keyframes glow-text {
            0% { text-shadow: 0 0 10px #f1c40f; }
            100% { text-shadow: 0 0 20px #f1c40f, 0 0 30px #f1c40f; }
        }

        .city-table-wrapper {
            flex: 1 1 45%;  /* ocupa casi la mitad */
            min-width: 350px;
            background: rgba(26, 42, 58, 0.7);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            border: 2px solid #e74c3c;
        }

        .city-table-wrapper h2 {
            color: #ecf0f1;
            font-family: 'Share Tech Mono', monospace;
            font-size: 1.8em;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #00ff00;
        }
        
        .table-container {
            display: flex;
            flex-direction: row; 
            justify-content: center;
            flex-wrap: wrap; 
            gap: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            background: rgba(52, 73, 94, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            color: #ecf0f1;
        }
        
        th, td {
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px;
            text-align: left;
        }
        
        th {
            background-color: rgba(231, 76, 60, 0.8);
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            font-family: 'Orbitron', sans-serif;
        }
        
        tr:nth-child(even) {
            background: rgba(46, 64, 83, 0.6);
        }
        
        tr:hover {
            background: rgba(74, 96, 119, 0.7);
        }
        
        #loading {
            text-align: center;
            font-size: 1.2em;
            color: #f1c40f;
            margin-top: 30px;
            font-family: 'Share Tech Mono', monospace;
        }
        
        .error-message {
            color: #e74c3c;
            text-align: center;
            margin-top: 20px;
            font-weight: bold;
            font-family: 'Share Tech Mono', monospace;
        }

        @media (max-width: 768px) {
            .table-container {
                flex-direction: column;
                align-items: center;
            }
            .city-table-wrapper {
                width: 90%; 
            }
        }
    </style>
</head>
<body>
    <h1>Progreso de Usuarios por Ciudad</h1>

    <div id="loading">Cargando datos...</div>
    <div id="errorMessage" class="error-message" style="display:none;"></div>

    <div class="table-container">
        <div class="city-table-wrapper">
            <h2>Bahía Blanca</h2>
            <table id="bahiaBlancaTable">
                <thead>
                    <tr>
                        <th>Nombre del Usuario</th>
                        <th>Máximo Game Page</th>
                        <th>Tiempo Total (segundos)</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div class="city-table-wrapper">
            <h2>Paraná</h2>
            <table id="paranaTable">
                <thead>
                    <tr>
                        <th>Nombre del Usuario</th>
                        <th>Máximo Game Page</th>
                        <th>Tiempo Total (segundos)</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        async function fetchUserData() {
            const loadingDiv = document.getElementById('loading');
            const errorMessageDiv = document.getElementById('errorMessage');
            loadingDiv.style.display = 'block';
            errorMessageDiv.style.display = 'none';

            const bahiaBlancaTableBody = document.querySelector('#bahiaBlancaTable tbody');
            const paranaTableBody = document.querySelector('#paranaTable tbody');

            bahiaBlancaTableBody.innerHTML = '';
            paranaTableBody.innerHTML = '';

            const SPREADSHEET_ID = '1kfNWpoj-Svouh1Q7xiug67MEjTWDdeItL96sCLS_p7w';
            const API_KEY = 'AIzaSyAY4PTzTAqm0mwJvV742E0ZTUNQH63BQbg';
            const RANGE = 'Hoja 1!A1:E';

            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.values && data.values.length > 1) {
                    const rows = data.values.slice(1);

                    const usersByCity = {
                        'Bahía Blanca': new Map(),
                        'Paraná': new Map()
                    };

                    rows.forEach(row => {
                        const userName = row[1];
                        const city = row[2];
                        const gamePageRaw = row[3];
                        const timeTakenRaw = row[4];

                        let gamePageValue = gamePageRaw === 'Registro' ? 0 : parseInt(gamePageRaw);
                        const timeTakenValue = parseInt(timeTakenRaw);

                        if (userName && city && !isNaN(gamePageValue)) {
                            if (usersByCity[city]) {
                                if (!usersByCity[city].has(userName)) {
                                    usersByCity[city].set(userName, {
                                        maxGamePage: -1,
                                        totalTime: 0
                                    });
                                }
                                const userData = usersByCity[city].get(userName);
                                if (gamePageValue > userData.maxGamePage) {
                                    userData.maxGamePage = gamePageValue;
                                }
                                if (!isNaN(timeTakenValue)) {
                                    userData.totalTime += timeTakenValue;
                                }
                            }
                        }
                    });

                    function populateTable(tableBody, usersMap) {
                        if (usersMap.size > 0) {
                            const sortedUsers = Array.from(usersMap.entries()).sort((a, b) => {
                                const pageA = a[1].maxGamePage;
                                const pageB = b[1].maxGamePage;
                                const timeA = a[1].totalTime;
                                const timeB = b[1].totalTime;
                                if (pageA !== pageB) {
                                    return pageB - pageA;
                                }
                                return timeA - timeB;
                            });
                            sortedUsers.forEach(([userName, data]) => {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                                    <td>${userName}</td>
                                    <td>${data.maxGamePage === 0 ? 'Registro' : data.maxGamePage}</td>
                                    <td>${data.totalTime}</td>
                                `;
                                tableBody.appendChild(tr);
                            });
                        } else {
                            tableBody.innerHTML = '<tr><td colspan="3">No hay datos disponibles para esta ciudad.</td></tr>';
                        }
                    }

                    populateTable(bahiaBlancaTableBody, usersByCity['Bahía Blanca']);
                    populateTable(paranaTableBody, usersByCity['Paraná']);

                } else {
                    bahiaBlancaTableBody.innerHTML = '<tr><td colspan="3">No hay datos disponibles en la hoja de cálculo.</td></tr>';
                    paranaTableBody.innerHTML = '<tr><td colspan="3">No hay datos disponibles en la hoja de cálculo.</td></tr>';
                }

            } catch (error) {
                console.error('Error al obtener los datos:', error);
                errorMessageDiv.textContent = `Error al cargar los datos: ${error.message}. Por favor, revisa tu clave de API y el acceso a la hoja.`;
                errorMessageDiv.style.display = 'block';
                bahiaBlancaTableBody.innerHTML = '<tr><td colspan="3">Error al cargar.</td></tr>';
                paranaTableBody.innerHTML = '<tr><td colspan="3">Error al cargar.</td></tr>';
            } finally {
                loadingDiv.style.display = 'none';
            }
        }
        
        document.addEventListener('DOMContentLoaded', fetchUserData);
        setInterval(fetchUserData, 5000);
    </script>
</body>
</html>
